---
- name: Group hosts dynamically
  hosts: all
  tags: always
  tasks:
    - name: Classify the host based on its OS distribution
      ansible.builtin.group_by:
        key: "dyn_os_{{ ansible_distribution | lower }}"
      changed_when: false

    - name: Classify the host based on its system vendor
      ansible.builtin.group_by:
        key: "dyn_sys_{{ ansible_system_vendor | lower | regex_replace('\\W', ' ') | split(' ') | first }}"
      changed_when: false

    - name: Classify the host based on whether we're running Ansible inside a chroot
      ansible.builtin.group_by:
        key: "dyn_stage_{{ 'bootstrap' if ansible_is_chroot | default(false) | bool else 'live' }}"
      changed_when: false

    - name: Assign special dynamic groups
      ansible.builtin.include_tasks:
        file: tasks/special_dynamic_groups.yml
      loop:
        - longhorn
        - tailscale
        - k3s_cluster_init_server
        - k3s_server

- name: Show additional information on a host
  hosts: all
  tags: info
  tasks:
    # yamllint disable rule:line-length
    - name: Show host distribution, release name, and version
      vars:
        msg: |
          Hardware Vendor: {{ ansible_system_vendor }}, {{ ansible_product_name }}, {{ ansible_product_version }}
          Arch: ansible_architecture={{ ansible_architecture }}, ansible_machine={{ ansible_machine }}
          OS Fam.: {{ ansible_os_family }}, {{ ansible_system }}
          OS Dist.: {{ ansible_distribution }}, {{ ansible_distribution_release }}, {{ ansible_distribution_version }}
          Hostnames: ansible_host={{ ansible_host }}, ansible_hostname={{ ansible_hostname }}, ansible_fqdn={{ ansible_fqdn }}, ansible_nodename={{ ansible_nodename }}
          Ansible Inventory: {{ inventory_hostname }}, {{ inventory_hostname_short }}
          Ansible Groups: {{ group_names }}
      ansible.builtin.debug:
        msg: "{{ msg.split('\n') }}"
# yamllint enable rule:line-length

- name: Perform setup tasks for bootstrapping hosts
  hosts: dyn_stage_bootstrap
  tags: dyn_stage_bootstrap
  become: true
  tasks:
    - name: Clean up leftovers from bootstrapping
      ansible.builtin.import_tasks:
        file: tasks/bootstrap_cleanup.yml

    - name: Apply baseline tasks
      ansible.builtin.import_tasks:
        file: tasks/baseline.yml

- name: Apply the baseline to all systems
  hosts: dyn_stage_live
  tags: 
    - dyn_stage_live
    - baseline
  tasks:
    - name: Apply baseline tasks
      ansible.builtin.import_tasks:
        file: tasks/baseline.yml

- name: Perform tasks specific to Apple hardware
  hosts: dyn_sys_apple
  tags: mbpfan
  roles:
    - nausicaea.fancontrol

- name: Provision Longhorn prerequisites
  hosts: dyn_stage_live_and_longhorn
  tags: longhorn
  roles:
    - nausicaea.longhorn

- name: Provision Tailscale
  hosts: dyn_stage_live_and_tailscale
  tags: tailscale
  roles:
    - nausicaea.tailscale

- name: Provision the K3s cluster init server node
  hosts: dyn_stage_live_and_k3s_cluster_init_server
  tags: 
    - k3s
    - k3s_cluster_init_server
  module_defaults:
    kubernetes.core.k8s:
      kubeconfig: "{{ nausicaea.common.ansible_home }}/.kube/config"
      validate_certs: true
      # validate:
      #   fail_on_error: true
      #   strict: true
  tasks:
    - name: Install and configure K3s
      tags: cluster_init
      ansible.builtin.import_role:
        name: nausicaea.k3s_cluster_init_server

    - name: Install and configure Cilium
      tags: cilium
      ansible.builtin.import_role:
        name: nausicaea.cilium

    - name: Install and configure Kube-VIP
      tags: kube_vip
      ansible.builtin.import_role:
        name: nausicaea.kube_vip

    - name: Install and configure Sealed Secrets
      tags: sealed_secrets
      ansible.builtin.import_role:
        name: nausicaea.sealed_secrets

    - name: Install and configure ArgoCD
      tags: argocd
      ansible.builtin.import_role:
        name: nausicaea.argocd

- name: Provision K3S server nodes
  hosts: dyn_stage_live_and_k3s_server
  serial: 1
  tags: 
    - k3s
    - k3s_server
  roles:
    - nausicaea.k3s_server

