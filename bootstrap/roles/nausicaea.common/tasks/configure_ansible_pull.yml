- name: Configure the ansible.cfg file
  ansible.builtin.template:
    src: ansible.cfg.j2
    dest: /etc/ansible/ansible.cfg
    owner: root
    group: root
    mode: "0644"
  notify: Etckeeper commit
  become: true

- name: Configure Ansible Galaxy requirements
  ansible.builtin.template:
    src: ansible-requirements.yml.j2
    dest: /etc/ansible/ansible-requirements.yml
    owner: root
    group: root
    mode: "0644"
  notify: Etckeeper commit
  become: true

- name: Ensure the vault password file has correct permissions
  ansible.builtin.file:
    path: "{{ nausicaea_common.ansible_vault_password_file }}"
    owner: "{{ nausicaea_common.ansible_user }}"
    group: "{{ nausicaea_common.ansible_group }}"
    mode: "0600"
    state: file
  become: true

- name: Configure the systemd units
  ansible.builtin.template:
    src: "{{ item.path }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: "0644"
  notify: 
    - Reload Systemd
    - Etckeeper commit
  become: true
  loop:
    - path: ansible-pull.service.j2
      dest: /etc/systemd/system/ansible-pull.service
    - path: ansible-pull.timer.j2
      dest: /etc/systemd/system/ansible-pull.timer

- name: Enable the timer manually (this needs to work even without systemd available)
  ansible.builtin.file:
    src: /etc/systemd/system/ansible-pull.timer
    dest: /etc/systemd/system/timers.target.wants/ansible-pull.timer
    state: link
  notify: 
    - Reload Systemd
    - Etckeeper commit
  become: true

- name: Create convenience script for looking at Ansible Pull logs
  ansible.builtin.template:
    src: ansible-logs.sh.j2
    dest: /usr/local/bin/ansible-logs
    owner: root
    group: root
    mode: "0755"
  become: true
