---
- name: Download the K3s installer script
  ansible.builtin.get_url:
    url: https://get.k3s.io
    checksum: sha256:b0715fb49a4a1d32241ac23c222a1d343baa1f2846f25032b306d1b30dbacd15
    dest: /usr/local/bin/k3s-install
    owner: root
    group: root
    mode: "0500"
  become: true

- name: Provision the first server node
  when: inventory_hostname == groups[k3s_server_group_name][0]
  block:
    - name: Run the K3s installer for a server node (control pane)
      ansible.builtin.command:
        argv:
          - /usr/local/bin/k3s-install
      environment:
        INSTALL_K3S_EXEC: server
        INSTALL_K3S_CHANNEL: stable
      become: true

    - name: Make sure the K3s server service is running
      ansible.builtin.service:
        name: k3s
        state: started
        enabled: true
      become: true

