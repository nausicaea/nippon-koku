---
- name: Does the K3s kubeconfig exist?
  ansible.builtin.stat:
    path: /etc/rancher/k3s/k3s.yaml
  register: k3s_kubeconfig
  become: true

- name: Does the K3s manifests directory exist?
  ansible.builtin.stat:
    path: /var/lib/rancher/k3s/server/manifests
  register: k3s_manifests
  become: true

- name: Set facts for convenience
  ansible.builtin.set_fact:
    k3s_kubeconfig_exists: "{{ k3s_kubeconfig.stat.exists and k3s_kubeconfig.stat.isreg }}"
    k3s_manifests_exists: "{{ k3s_manifests.stat.exists and k3s_manifests.stat.isdir }}"

- name: Download the K3s installer script
  ansible.builtin.get_url:
    url: https://get.k3s.io
    checksum: sha256:9d5fc42bf825d3e8dcc8682c8bac071b1de18019af81f85519ccbe5c919e0896
    dest: /usr/local/sbin/k3s-install
    owner: root
    group: root
    mode: "0500"
  become: true

- name: Provision the first server node
  when: nausicaea.k3s_server.args.cluster_init
  block:
    - name: Create the TLS directory
      ansible.builtin.file:
        path: /var/lib/rancher/k3s/server/tls
        state: directory
        recurse: true
        owner: root
        group: root
        mode: "u=rwX,go="
      become: true

    - name: Extract the custom TLS certificates
      ansible.builtin.unarchive:
        src: k3s-server-tls.tgz
        dest: /var/lib/rancher/k3s/server/tls
        creates: /var/lib/rancher/k3s/server/tls/root-ca.crt
        owner: root
        group: root
        mode: "u=rwX,go="
      become: true

    - name: Copy the K3s token file
      ansible.builtin.copy:
        src: k3s-token
        dest: /var/lib/rancher/k3s/server/token
        owner: root
        group: root
        mode: "0600"
      become: true

    - name: DEBUG
      ansible.builtin.fail:
        msg: BREAK POINT

    - name: Run the K3s installer for a server node (control pane)
      ansible.builtin.command:
        argv:
          - /usr/local/sbin/k3s-install
          - server
          - "--cluster-init"
          - "--token-file"
          - "/var/lib/rancher/k3s/server/token"
        creates: /usr/local/bin/k3s
      become: true

    - name: Make sure the K3s server service is running
      ansible.builtin.service:
        name: k3s
        state: started
        enabled: true
      become: true

