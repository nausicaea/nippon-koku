---
- name: Does the K3s kubeconfig exist?
  ansible.builtin.stat:
    path: /etc/rancher/k3s/k3s.yaml
  register: k3s_kubeconfig
  become: true

- name: Does the K3s manifests directory exist?
  ansible.builtin.stat:
    path: /var/lib/rancher/k3s/server/manifests
  register: k3s_manifests
  become: true

- name: Set facts for convenience
  ansible.builtin.set_fact:
    k3s_kubeconfig_exists: "{{ k3s_kubeconfig.stat.exists and k3s_kubeconfig.stat.isreg }}"
    k3s_manifests_exists: "{{ k3s_manifests.stat.exists and k3s_manifests.stat.isdir }}"

- name: Download the K3s installer script
  ansible.builtin.get_url:
    url: https://get.k3s.io
    checksum: sha256:9d5fc42bf825d3e8dcc8682c8bac071b1de18019af81f85519ccbe5c919e0896
    dest: /usr/local/sbin/k3s-install
    owner: root
    group: root
    mode: "0500"
  become: true

- name: Provision the first server node
  when: inventory_hostname == groups[k3s_server_group_name][0]
  block:
    - name: Run the K3s installer for a server node (control pane)
      ansible.builtin.command:
        argv:
          - /usr/local/sbin/k3s-install
      environment:
        INSTALL_K3S_EXEC: server
        INSTALL_K3S_CHANNEL: stable
      become: true

    - name: Make sure the K3s server service is running
      ansible.builtin.service:
        name: k3s
        state: started
        enabled: true
      become: true

