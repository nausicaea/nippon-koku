- name: Create the Tailscale zone
  ansible.posix.firewalld:
    zone: "{{ nausicaea_tailscale_vars.firewalld_zone }}"
    state: present
    permanent: true
  become: true

- name: Bind the Tailscale zone to the tailscale0 interface
  ansible.posix.firewalld:
    zone: "{{ nausicaea_tailscale_vars.firewalld_zone }}"
    interface: tailscale0
    state: enabled
    permanent: true
  become: true

- name: Accept all traffic in the tailscale zone
  ansible.posix.firewalld:
    zone: "{{ nausicaea_tailscale_vars.firewalld_zone }}"
    target: ACCEPT
    state: enabled
    permanent: true
  become: true

- name: Create the Tailscale service
  ansible.builtin.command:
    argv:
      - firewall-cmd
      - "--permanent"
      - "--new-service={{ nausicaea_tailscale_vars.firewalld_p2p_service }}"
    creates: "/etc/firewalld/services/{{ nausicaea_tailscale_vars.firewalld_p2p_service }}.xml"
  register: firewalld_new_service
  become: true

- name: Reload firewalld after creating the service
  ansible.builtin.command:
    argv:
      - firewall-cmd
      - "--reload"
  become: true
  when: firewalld_new_service.changed

- name: Was the UDP P2P port already assigned to the Tailscale service?
  ansible.builtin.command:
    argv:
      - firewall-cmd
      - "--permanent"
      - "--service={{ nausicaea_tailscale_vars.firewalld_p2p_service }}"
      - "--query-port={{ nausicaea_tailscale_vars.firewalld_p2p_port }}"
  register: firewalld_tailscale_port
  failed_when: not (firewalld_tailscale_port.rc == 0 or firewalld_tailscale_port.rc == 1)
  changed_when: false
  become: true

- name: DEBUG
  ansible.builtin.debug:
    var: firewalld_tailscale_port

- fail:
    msg: STOP

- name: Assign the UDP P2P port to the Tailscale service
  ansible.builtin.command:
    argv:
      - firewall-cmd
      - "--permanent"
      - "--service={{ nausicaea_tailscale_vars.firewalld_p2p_service }}"
      - "--add-port={{ nausicaea_tailscale_vars.firewalld_p2p_port }}"
      - "--set-short='Tailscale'"
      - "--set-description='Tailscale Wireguard P2P channel port'"
  become: true
  when: firewalld_tailscale_port.rc == 1

- name: Accept traffic on the Tailscale port in the public zone
  ansible.posix.firewalld:
    zone: public
    service: "{{ nausicaea_tailscale_vars.firewalld_p2p_service }}"
    state: enabled
    permanent: true
  become: true
