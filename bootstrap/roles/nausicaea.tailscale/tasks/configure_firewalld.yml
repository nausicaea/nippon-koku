- name: Create the Tailscale zone
  ansible.posix.firewalld:
    zone: tailscale
    state: present
    permanent: true
  become: true

- name: Bind the Tailscale zone to the tailscale0 interface
  ansible.posix.firewalld:
    zone: tailscale
    interface: tailscale0
    state: enabled
    permanent: true
  become: true

- name: Accept all traffic in the tailscale zone
  ansible.posix.firewalld:
    zone: tailscale
    target: ACCEPT
    state: enabled
    permanent: true
  become: true

- name: Create the Tailscale service
  ansible.builtin.command:
    argv:
      - firewall-cmd
      - "--permanent"
      - "--new-service=tailscale"
    creates: /etc/firewalld/services/tailscale.xml
  register: firewalld_new_service
  become: true

- name: DEBUG
  ansible.builtin.debug:
    var: firewalld_new_service

- name: Reload firewalld after creating the service
  ansible.builtin.command:
    argv:
      - firewall-cmd
      - "--reload"
  when: firewalld_new_service.changed
  become: true

- name: Assign the UDP P2P port to the Tailscale service
  ansible.builtin.firewalld:
    service: tailscale
    port: 41641/udp
    state: enabled
    permanent: true
  become: true

- name: Accept traffic on the Tailscale port in the public zone
  ansible.posix.firewalld:
    zone: public
    service: tailscale
    state: enabled
    permanent: true
  become: true

# - name: Configure Tailscale as application for UFW
#   ansible.builtin.template:
#     src: ufw-tailscale.j2
#     dest: /etc/ufw/applications.d/tailscale
#     owner: root
#     group: root
#     mode: "0644"
#   become: true
#   notify: Update ufw apps
# 
# - name: Configure UFW to allow access to the Tailscale Wireguard port from anywhere
#   community.general.ufw:
#     comment: Allow Wireguard traffic from anywhere
#     rule: allow
#     app: TailscaleWireguard
#   become: true
# 
# - name: Configure UFW to allow any and all Tailscale traffic
#   community.general.ufw:
#     comment: Allow any traffic on the Tailnet
#     rule: allow
#     direction: in
#     interface: tailscale0
#   become: true
