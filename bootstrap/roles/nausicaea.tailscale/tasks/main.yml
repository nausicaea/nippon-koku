---
- name: Ensure the keyrings directory exists
  ansible.builtin.file:
    path: "{{ nausicaea_tailscale_vars.operator_keyrings }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true

- name: Calculate the keyring path
  ansible.builtin.set_fact:
    tailscale_keyring_path: "{{ nausicaea_tailscale_vars.operator_keyrings }}/{{ nausicaea_tailscale_vars.keyring_name }}"

- name: Ensure presence of the Tailscale keyring
  ansible.builtin.get_url:
    url: "https://pkgs.tailscale.com/stable/{{ ansible_distribution | lower }}/{{ ansible_distribution_release | lower }}.noarmor.gpg"
    checksum: sha256:3e03dacf222698c60b8e2f990b809ca1b3e104de127767864284e6c228f1fb39
    dest: "{{ tailscale_keyring_path }}"
    owner: root
    group: root
    mode: "0644"
  become: true

# yamllint disable rule:line-length
- name: Ensure presence of the Tailscale repository key
  ansible.builtin.apt_repository:
    repo: "deb [signed-by={{ tailscale_keyring_path }}] https://pkgs.tailscale.com/stable/{{ ansible_distribution | lower }} {{ ansible_distribution_release | lower
      }} main"
    filename: "{{ nausicaea_tailscale_vars.repo_filename }}"
    state: present
  become: true
# yamllint enable rule:line-length

- name: Provision sysctl customizations for Tailscale
  ansible.builtin.copy:
    src: sysctl-tailscale.conf
    dest: /etc/sysctl.d/99-tailscale.conf
    owner: root
    group: root
    mode: "0644"
  notify: Force Reload Procps
  become: true
  when: nausicaea_tailscale.enable_exit_node

- name: Ensure Tailscale is installed
  ansible.builtin.apt:
    name: tailscale
    state: present
  become: true

- name: Enable the Tailscale daemon
  ansible.builtin.service:
    name: tailscaled
    enabled: true
    state: started
  become: true

- name: Configure firewalld
  ansible.builtin.import_tasks:
    file: configure_firewalld.yml
