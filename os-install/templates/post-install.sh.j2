#!/bin/sh

set -x

echo "START POST INSTALL"

apt-get install -y ansible-core git curl

BOOTSTRAP_REPO="{{ repo }}"
BOOTSTRAP_BRANCH="{{ branch }}"
STAGING_DIR=$(mktemp -d)

git clone "$BOOTSTRAP_REPO" "$STAGING_DIR"

cd "${STAGING_DIR}/bootstrap"

git checkout "$BOOTSTRAP_BRANCH"

ansible-playbook -vv -c local site.yml || \
    ANSIBLE_STATUS="$?" \\
    echo "ERROR: Ansible run failed with status code $ANSIBLE_STATUS"

echo "END POST INSTALL"
