#!/bin/sh

set -e

echo "START POST INSTALL"

BOOTSTRAP_REPO="{{ repo }}"
BOOTSTRAP_BRANCH="{{ branch }}"

echo "PI: Stage 1"
apt-get install -qy ansible-core git curl

echo "PI: Stage 2"
STAGING_DIR=$(mktemp -d)
git clone "$BOOTSTRAP_REPO" "$STAGING_DIR"
cd "${STAGING_DIR}/bootstrap"
git checkout "$BOOTSTRAP_BRANCH"

if [ ! -e /dev/shm ]; then
    mkdir -vp /dev/shm
fi

echo "PI: Stage 3"
ansible-galaxy collection install -r ansible-requirements.yml

echo "PI: Stage 4"
ansible-playbook -c local site.yml || \
    printf 'ERROR: Ansible run failed with status code %s\n' "$?"

if [ -e /dev/shm ]; then
    rmdir -v /dev/shm
fi

echo "END POST INSTALL"
