#!/bin/sh

set -e

echo "START POST INSTALL"

apt-get install -qy ansible-core git curl

BOOTSTRAP_REPO="{{ repo }}"
BOOTSTRAP_BRANCH="{{ branch }}"
STAGING_DIR=$(mktemp -d)

git clone "$BOOTSTRAP_REPO" "$STAGING_DIR"

cd "${STAGING_DIR}/bootstrap"

git checkout "$BOOTSTRAP_BRANCH"

if [ ! -e /dev/shm ]; then
    mkdir -vp /dev/shm
fi

ansible --version

ansible-galaxy collection install -r ansible-requirements.yml

ansible-playbook -c local site.yml || \
    printf 'ERROR: Ansible run failed with status code %s\n' "$?"

if [ -e /dev/shm ]; then
    rmdir -v /dev/shm
fi

echo "END POST INSTALL"
